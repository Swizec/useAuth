{"version":3,"file":"index.umd.js","sources":["../src/authReducer.ts","../src/useAuth.ts","../src/AuthProvider.tsx"],"sourcesContent":["import { AuthState, AuthAction } from \"./types\";\n\nexport const authReducer = (\n    state: AuthState,\n    action: AuthAction\n): AuthState => {\n    switch (action.type) {\n        case \"login\":\n            const { authResult, user } = action;\n            const expiresAt =\n                authResult.expiresIn! * 1000 + new Date().getTime();\n\n            if (typeof localStorage !== \"undefined\") {\n                localStorage.setItem(\n                    \"useAuth:expires_at\",\n                    JSON.stringify(expiresAt)\n                );\n                localStorage.setItem(\"useAuth:user\", JSON.stringify(user));\n            }\n\n            return {\n                ...state,\n                user,\n                expiresAt,\n                authResult\n            };\n        case \"logout\":\n            if (typeof localStorage !== \"undefined\") {\n                localStorage.removeItem(\"useAuth:expires_at\");\n                localStorage.removeItem(\"useAuth:user\");\n            }\n\n            return {\n                ...state,\n                user: {},\n                expiresAt: null,\n                authResult: null\n            };\n        case \"stopAuthenticating\":\n            return {\n                ...state,\n                isAuthenticating: false\n            };\n        case \"startAuthenticating\":\n            return {\n                ...state,\n                isAuthenticating: true\n            };\n        case \"error\":\n            const { errorType, error } = action;\n            return {\n                ...state,\n                user: {},\n                expiresAt: null,\n                authResult: null,\n                errorType,\n                error\n            };\n        default:\n            return state;\n    }\n};\n","import { useContext } from \"react\";\n\nimport { AuthContext } from \"./AuthProvider\";\nimport {\n    useAuthInterface,\n    handleAuthResultInterface,\n    setSessionInterface\n} from \"./types\";\nimport {\n    Auth0DecodedHash,\n    Auth0UserProfile,\n    Auth0Error,\n    Auth0ParseHashError\n} from \"auth0-js\";\n\nconst setSession: setSessionInterface = async ({\n    dispatch,\n    auth0,\n    authResult\n}) => {\n    return new Promise((resolve, reject) => {\n        auth0.client.userInfo(\n            authResult.accessToken || \"\",\n            (err: Auth0Error | null, user: Auth0UserProfile) => {\n                if (err) {\n                    dispatch({\n                        type: \"error\",\n                        errorType: \"userInfo\",\n                        error: err\n                    });\n                    reject(err);\n                } else {\n                    dispatch({\n                        type: \"login\",\n                        authResult,\n                        user\n                    });\n                    resolve(user);\n                }\n            }\n        );\n    });\n};\n\nexport const handleAuthResult: handleAuthResultInterface = async ({\n    err,\n    dispatch,\n    auth0,\n    authResult\n}) => {\n    dispatch({\n        type: \"stopAuthenticating\"\n    });\n\n    if (authResult && authResult.accessToken && authResult.idToken) {\n        try {\n            await setSession({ dispatch, auth0, authResult });\n\n            return true;\n        } catch (e) {\n            return false;\n        }\n    } else if (err) {\n        console.error(err);\n        dispatch({\n            type: \"error\",\n            error: err,\n            errorType: \"authResult\"\n        });\n\n        return false;\n    } else {\n        return false;\n    }\n};\n\nexport const useAuth: useAuthInterface = () => {\n    const { state, dispatch, auth0, callback_domain, navigate } = useContext(\n        AuthContext\n    );\n\n    const login = () => {\n        auth0 && auth0.authorize();\n    };\n\n    const signup = () => {\n        auth0 && auth0.authorize({ screen_hint: \"signup\" });\n    };\n\n    const logout = () => {\n        auth0 &&\n            auth0.logout({\n                returnTo: callback_domain\n            });\n        dispatch({\n            type: \"logout\"\n        });\n\n        // Return to the homepage after logout.\n        navigate(\"/\");\n    };\n\n    const handleAuthentication = ({ postLoginRoute = \"/\" } = {}) => {\n        if (typeof window !== \"undefined\") {\n            dispatch({\n                type: \"startAuthenticating\"\n            });\n\n            auth0 &&\n                auth0.parseHash(\n                    async (\n                        err: Auth0ParseHashError | null,\n                        authResult: Auth0DecodedHash | null\n                    ) => {\n                        await handleAuthResult({\n                            err,\n                            authResult,\n                            dispatch,\n                            auth0\n                        });\n\n                        navigate(postLoginRoute);\n                    }\n                );\n        }\n    };\n\n    const isAuthenticated = () => {\n        return !!(state.expiresAt && new Date().getTime() < state.expiresAt);\n    };\n\n    return {\n        isAuthenticating: state.isAuthenticating,\n        isAuthenticated,\n        user: state.user,\n        userId: state.user ? state.user.sub : null,\n        authResult: state.authResult,\n        login,\n        signup,\n        logout,\n        handleAuthentication\n    };\n};\n","import React, { createContext, useReducer, useEffect, useState } from \"react\";\nimport Auth0 from \"auth0-js\";\nimport { AuthOptions } from \"auth0-js\";\n\nimport { authReducer } from \"./authReducer\";\nimport { handleAuthResult } from \"./useAuth\";\nimport {\n    AuthProviderInterface,\n    AuthState,\n    AuthAction,\n    AuthContextState\n} from \"./types\";\n\nfunction getDefaultState(): AuthState {\n    const DEFAULT_STATE = {\n        user: {},\n        expiresAt: null,\n        isAuthenticating: false\n    };\n\n    let stored_state = {};\n\n    if (typeof localStorage !== \"undefined\") {\n        const expiresAt = new Date(\n            JSON.parse(localStorage.getItem(\"useAuth:expires_at\") || \"0\")\n        );\n\n        if (expiresAt > new Date()) {\n            stored_state = {\n                user: JSON.parse(localStorage.getItem(\"useAuth:user\") || \"{}\"),\n                expiresAt: expiresAt\n            };\n        }\n    }\n\n    return {\n        ...DEFAULT_STATE,\n        ...stored_state\n    };\n}\n\nexport const AuthContext = createContext<AuthContextState>({\n    state: getDefaultState(),\n    dispatch: () => {},\n    auth0: null,\n    callback_domain: \"http://localhost:8000\",\n    navigate: (path: string) => {}\n});\n\nexport const AuthProvider: AuthProviderInterface = ({\n    children,\n    navigate,\n    auth0_audience_domain,\n    auth0_domain,\n    auth0_client_id,\n    auth0_params\n}) => {\n    const callbackDomain =\n        typeof window !== \"undefined\"\n            ? `${window.location.protocol}//${window.location.host}`\n            : \"http://localhost:8000\";\n\n    const audienceDomain = auth0_audience_domain || auth0_domain;\n\n    const params: AuthOptions = {\n        domain: auth0_domain,\n        clientID: auth0_client_id,\n        redirectUri: `${callbackDomain}/auth0_callback`,\n        audience: `https://${audienceDomain}/api/v2/`,\n        responseType: \"token id_token\",\n        scope: \"openid profile email\"\n    };\n\n    // Instantiate Auth0 client\n    const auth0 = new Auth0.WebAuth({ ...params, ...auth0_params });\n\n    // Holds authentication state\n    const [state, dispatch] = useReducer<React.Reducer<AuthState, AuthAction>>(\n        authReducer,\n        getDefaultState()\n    );\n\n    const [contextValue, setContextValue] = useState<AuthContextState>({\n        state,\n        dispatch,\n        auth0,\n        callback_domain: callbackDomain,\n        navigate\n    });\n\n    // Update context value and trigger re-render\n    // This patterns avoids unnecessary deep renders\n    // https://reactjs.org/docs/context.html#caveats\n    useEffect(() => {\n        setContextValue((contextValue: AuthContextState) => ({\n            ...contextValue,\n            state\n        }));\n    }, [state]);\n\n    // Verify user is logged-in on AuthProvider mount\n    // Avoids storing sensitive data in local storage\n    useEffect(() => {\n        dispatch({\n            type: \"startAuthenticating\"\n        });\n\n        auth0.checkSession({}, (err, authResult) => {\n            dispatch({\n                type: \"stopAuthenticating\"\n            });\n\n            console.log(err);\n            if (err) {\n                dispatch({\n                    type: \"error\",\n                    errorType: \"checkSession\",\n                    error: err\n                });\n            } else {\n                handleAuthResult({ dispatch, auth0, authResult });\n            }\n        });\n    }, []);\n\n    return (\n        <AuthContext.Provider value={contextValue}>\n            {children}\n        </AuthContext.Provider>\n    );\n};\n"],"names":["authReducer","state","action","type","authResult","user","expiresAt","expiresIn","Date","getTime","localStorage","setItem","JSON","stringify","removeItem","isAuthenticating","errorType","error","handleAuthResult","err","dispatch","auth0","accessToken","idToken","Promise","resolve","reject","client","userInfo","setSession","console","getDefaultState","stored_state","parse","getItem","AuthContext","createContext","callback_domain","navigate","path","children","auth0_domain","auth0_params","callbackDomain","window","location","protocol","host","Auth0","WebAuth","domain","clientID","auth0_client_id","redirectUri","audience","auth0_audience_domain","responseType","scope","useReducer","useState","contextValue","setContextValue","useEffect","checkSession","log","React","Provider","value","useContext","isAuthenticated","userId","sub","login","authorize","signup","screen_hint","logout","returnTo","handleAuthentication","postLoginRoute","parseHash"],"mappings":"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"}